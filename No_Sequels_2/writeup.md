# No Sequels 2

## 手順
以下、No Sequels (ångstromCTF 2019)を前問と呼ぶ。  
前問のソースを読むと前問のログイン成功時にCookieに`name`と`authenticated=true`が暗号化された上でセットされる。  
暗号化していることから手元のCookieを改ざんするのは難しいと考えられる。  
また、おそらく`name="admin"`がセットされている(前問では名前を直接指定せず1つテーブルを取ってくるだけだった)。  
この時点でadminのパスワードはわからず、それと入力を比べるためこの問題のソースコードから脆弱性を探すのは困難だと考えられる。  
というわけで前問に戻り同じように検索演算子を利用して情報を探れないか考える。  
通常のSQLインジェクションでは取得結果が表示されることもあるが今回はログイン認証にだけ使っているため結果を表示させることはできない。  
また、ログインできた際にリダイレクトするのに対し、失敗した時は単に失敗ページを出すだけなのでBoolean-BasedのブラインドSQLインジェクションができると考えられる。  
MongoDBの検索演算子には$regexという正規表現を扱えるものがある。これに前問同様の渡し方で引数に正規表現を入れてJSONで渡せばデータベース内のレコードを詳しく検索することができる。  
例えば
```javascript
var query = {
	username : {"$regex" : "$a.*^"}
}
```
として送り込めばusernameがaから始まるレコードを探す。  
あとはBoolean-BasedのブラインドSQLインジェクションのセオリーをNoSQLのMongoDBにも適応して正規表現で各文字がpasswordのどの位置に現れるかを調べながら答えを探る(詳細コードはexploit.pyとして添付)。  
コードの概要としては注入したqueryでステータスコードが302であれば条件のレコードが存在することを判定条件とし、計算量削減の為に予めパスワード内で使われている文字を列挙し、それを使って1文字目を探り、次に2文字目を探り…としてパスワードを頭から解読していく。

## Flag
パスワードに上記手段で得られたパスワード、congratsyouwinを入力するとフラグ`actf{still_no_sql_in_the_sequel}`が得られる
